<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos de Belleza Coreana</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos para el modal */
        .product-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .product-modal {
            background: white;
            border-radius: 8px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
            position: relative;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            z-index: 10;
        }

        .modal-close:hover {
            background-color: #f5f5f5;
        }

        .modal-content {
            padding: 30px;
        }

        .modal-product-info {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }

        .modal-product-image {
            flex: 0 0 300px;
        }

        .modal-product-image .image-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f5f5f5;
            position: relative;
        }

        .modal-product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: white;
        }

        .modal-product-details {
            flex: 1;
            min-width: 300px;
        }

        .modal-product-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-product-price {
            font-size: 28px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .modal-description {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .modal-description h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .modal-description p {
            color: #666;
            line-height: 1.6;
        }

        /* Cursor pointer para tarjetas de producto */
        .product-card {
            cursor: pointer;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Bot√≥n de ver detalles */
        .btn-view-details {
            background-color: transparent;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .btn-view-details:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }

        /* Acciones en tarjetas */
        .product-card-actions {
            margin-top: 10px;
        }

        .product-card .btn-add {
            width: 100%;
            margin-top: 8px;
        }

        /* Main content padding */
        main {
            padding: 30px 0;
        }

        /* Secci√≥n de productos */
        .productos-section {
            padding: 40px 0;
        }

        /* Indicador de carga */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
            grid-column: 1 / -1;
        }

        .loading i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        /* Header del carrito */
        .header-icons {
            position: relative;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #d97777;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Estilos para im√°genes de productos */
        .product-card-image {
            height: 200px;
            overflow: hidden;
            position: relative;
            background-color: #f5f5f5;
            border-radius: 8px 8px 0 0;
        }

        .product-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-card-image img {
            transform: scale(1.05);
        }

        .image-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0e6d6;
            color: #666;
            font-weight: bold;
            font-size: 16px;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 40px;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover {
            background-color: #f5f5f5;
        }

        .page-btn.active {
            background-color: #333;
            color: white;
            border-color: #333;
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Filtros */
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            min-width: 150px;
        }
    </style>
</head>
<body>
    <!-- SCRIPT DE LIMPIEZA AUTOM√ÅTICA MEJORADO -->
    <script>
        (function() {
            const CARRITO_KEY = 'carrito_belleza_coreana';
            
            // Solo limpiar si hay datos corruptos
            const carritoJSON = localStorage.getItem(CARRITO_KEY);
            
            if (carritoJSON) {
                try {
                    const carrito = JSON.parse(carritoJSON);
                    
                    // Verificar estructura v√°lida
                    const esValido = Array.isArray(carrito) && 
                        carrito.every(item => 
                            item && 
                            typeof item === 'object' && 
                            'id' in item && 
                            'cantidad' in item &&
                            Number.isInteger(item.id) &&
                            Number.isInteger(item.cantidad) &&
                            item.cantidad > 0 &&
                            item.cantidad <= 99
                        );
                    
                    if (!esValido) {
                        console.log('üßπ Limpiando carrito corrupto...');
                        localStorage.removeItem(CARRITO_KEY);
                        console.log('‚úÖ Carrito limpiado');
                    }
                } catch (error) {
                    console.log('üßπ Error al leer carrito, limpiando...', error);
                    localStorage.removeItem(CARRITO_KEY);
                }
            }
        })();
    </script>
    
    <!-- Header con navegaci√≥n -->
    <header>
        <div class="container header-container">
            <div class="logo">Belleza<span>Coreana</span></div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar productos...">
                <button onclick="buscarProductos()"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="header-icons">
                <a href="carrito.html"><i class="fas fa-shopping-cart"></i><span class="cart-badge" id="cartBadge">0</span></a>
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="productos-section">
        <div class="container">
            <!-- Contador de productos -->
            <div class="products-header" style="margin-bottom: 20px;">
                <h2 style="margin-bottom: 5px;">Nuestros Productos</h2>
                <p id="productCount" style="color: #666;">Cargando productos...</p>
            </div>
            
            <!-- Filtros -->
            <div class="filters-container" id="filtersContainer" style="display: none;">
                <select id="filterCategory" class="filter-select" onchange="aplicarFiltros()">
                    <option value="">Todas las categor√≠as</option>
                </select>
                <select id="filterBrand" class="filter-select" onchange="aplicarFiltros()">
                    <option value="">Todas las marcas</option>
                </select>
                <select id="sortBy" class="filter-select" onchange="aplicarFiltros()">
                    <option value="nombre">Ordenar por: Nombre</option>
                    <option value="precio-asc">Precio: Menor a Mayor</option>
                    <option value="precio-desc">Precio: Mayor a Menor</option>
                    <option value="marca">Marca</option>
                </select>
            </div>
            
            <!-- Grid de productos -->
            <div class="products-grid" id="productsContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Cargando productos...
                </div>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="pagination" id="paginationContainer" style="display: none;"></div>
        </div>
    </main>

    <!-- Footer vac√≠o - solo espacio en blanco -->
    <footer>
        <div class="container">
            <!-- Espacio en blanco -->
        </div>
    </footer>

    <!-- Modal para detalles del producto -->
    <div id="productModal" class="product-modal-overlay"></div>

    <script>
        // =================== VARIABLES GLOBALES ===================
        let todosProductos = [];           // Todos los productos del JSON
        let productosFiltrados = [];       // Productos despu√©s de filtros
        let productosMostrados = [];       // Productos que se muestran actualmente
        let productosPorPagina = 12;       // Cantidad de productos por p√°gina
        let paginaActual = 1;              // P√°gina actual
        let marcasUnicas = new Set();      // Marcas √∫nicas para filtros
        let categoriasUnicas = new Set();  // Categor√≠as √∫nicas para filtros
        
        // =================== FUNCIONES PRINCIPALES ===================
        
        // Funci√≥n para cargar productos desde el JSON
        async function cargarProductos() {
            try {
                console.log('üîÑ Cargando productos desde products.json...');
                
                // Intentar varias rutas posibles para el JSON
                const rutas = [
                    'products.json',
                    './products.json',
                    '/products.json',
                    'products.json?v=' + Date.now()
                ];
                
                let data = null;
                
                for (const ruta of rutas) {
                    try {
                        const response = await fetch(ruta);
                        if (response.ok) {
                            data = await response.json();
                            console.log(`‚úÖ JSON cargado desde: ${ruta}`);
                            break;
                        }
                    } catch (error) {
                        console.log(`‚ùå Error con ruta ${ruta}:`, error.message);
                    }
                }
                
                if (!data || !data.productos) {
                    throw new Error('No se pudieron cargar los productos');
                }
                
                todosProductos = data.productos;
                console.log(`‚úÖ ${todosProductos.length} productos cargados exitosamente`);
                
                // Extraer marcas y categor√≠as √∫nicas para filtros
                extraerFiltrosUnicos();
                
                // Inicializar productos filtrados
                productosFiltrados = [...todosProductos];
                
                // Mostrar productos
                mostrarProductos();
                actualizarContadorProductos();
                actualizarContadorCarrito();
                
                // Mostrar filtros
                mostrarFiltros();
                
            } catch (error) {
                console.error('‚ùå Error al cargar productos:', error);
                mostrarError('No se pudieron cargar los productos. Por favor, intenta m√°s tarde.');
            }
        }
        
        // Extraer marcas y categor√≠as √∫nicas para filtros
        function extraerFiltrosUnicos() {
            marcasUnicas.clear();
            categoriasUnicas.clear();
            
            todosProductos.forEach(producto => {
                if (producto.marca) marcasUnicas.add(producto.marca);
                if (producto.categoria) categoriasUnicas.add(producto.categoria);
            });
        }
        
        // Mostrar filtros en la interfaz
        function mostrarFiltros() {
            const filtersContainer = document.getElementById('filtersContainer');
            const filterCategory = document.getElementById('filterCategory');
            const filterBrand = document.getElementById('filterBrand');
            
            if (filtersContainer && filterCategory && filterBrand) {
                // Limpiar opciones existentes
                filterCategory.innerHTML = '<option value="">Todas las categor√≠as</option>';
                filterBrand.innerHTML = '<option value="">Todas las marcas</option>';
                
                // Agregar categor√≠as
                Array.from(categoriasUnicas).sort().forEach(categoria => {
                    filterCategory.innerHTML += `<option value="${categoria}">${categoria}</option>`;
                });
                
                // Agregar marcas
                Array.from(marcasUnicas).sort().forEach(marca => {
                    filterBrand.innerHTML += `<option value="${marca}">${marca}</option>`;
                });
                
                filtersContainer.style.display = 'flex';
            }
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            const filterCategory = document.getElementById('filterCategory');
            const filterBrand = document.getElementById('filterBrand');
            const sortBy = document.getElementById('sortBy');
            
            let productosTemp = [...todosProductos];
            
            // Aplicar filtro por categor√≠a
            if (filterCategory && filterCategory.value) {
                productosTemp = productosTemp.filter(p => p.categoria === filterCategory.value);
            }
            
            // Aplicar filtro por marca
            if (filterBrand && filterBrand.value) {
                productosTemp = productosTemp.filter(p => p.marca === filterBrand.value);
            }
            
            // Aplicar ordenamiento
            if (sortBy && sortBy.value) {
                switch(sortBy.value) {
                    case 'precio-asc':
                        productosTemp.sort((a, b) => a.precio - b.precio);
                        break;
                    case 'precio-desc':
                        productosTemp.sort((a, b) => b.precio - a.precio);
                        break;
                    case 'marca':
                        productosTemp.sort((a, b) => a.marca.localeCompare(b.marca));
                        break;
                    case 'nombre':
                    default:
                        productosTemp.sort((a, b) => a.nombre.localeCompare(b.nombre));
                        break;
                }
            }
            
            productosFiltrados = productosTemp;
            paginaActual = 1; // Volver a la primera p√°gina
            mostrarProductos();
            actualizarContadorProductos();
        }
        
        // Funci√≥n para mostrar productos en el grid
        function mostrarProductos() {
            const container = document.getElementById('productsContainer');
            if (!container) return;
            
            // Calcular √≠ndices para la paginaci√≥n
            const inicio = (paginaActual - 1) * productosPorPagina;
            const fin = inicio + productosPorPagina;
            productosMostrados = productosFiltrados.slice(inicio, fin);
            
            if (productosMostrados.length === 0) {
                container.innerHTML = `
                    <div class="no-products" style="text-align: center; padding: 40px; grid-column: 1/-1;">
                        <i class="fas fa-search" style="font-size: 48px; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 10px;">No se encontraron productos</h3>
                        <p>Intenta con otros t√©rminos de b√∫squeda o filtros</p>
                    </div>
                `;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            let html = '';
            
            productosMostrados.forEach(producto => {
                // URL de la imagen (puede ser URL externa o null)
                const imagenUrl = producto.imagen || null;
                
                // Determinar color de fondo seg√∫n categor√≠a (para placeholder)
                const colorFondo = getColorPorCategoria(producto.categoria);
                
                html += `
                    <div class="product-card" data-id="${producto.id}" onclick="abrirModalProducto(${producto.id})">
                        <div class="product-card-image">
                            ${imagenUrl ? 
                                `<img src="${imagenUrl}" 
                                      alt="${producto.nombre}"
                                      loading="lazy"
                                      onerror="manejarErrorImagen(this, '${producto.marca}', '${colorFondo}')">` 
                                : 
                                `<div class="image-placeholder" style="background-color: ${colorFondo}">
                                    ${producto.marca}
                                </div>`
                            }
                        </div>
                        
                        <div class="product-card-info">
                            <h3 class="product-card-title">${producto.nombre}</h3>
                            
                            <div class="product-card-price">
                                <span class="product-current-price">US$ ${producto.precio.toFixed(2)}</span>
                            </div>
                            
                            <div class="product-card-actions">
                                <button class="btn-view-details" onclick="event.stopPropagation(); abrirModalProducto(${producto.id})">
                                    VER DETALLES
                                </button>
                                <button class="btn-add" onclick="event.stopPropagation(); agregarAlCarrito(${producto.id}, this)">
                                    AGREGAR A LA CESTA
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Actualizar paginaci√≥n
            actualizarPaginacion();
        }
        
        // Funci√≥n para manejar errores de carga de im√°genes
        function manejarErrorImagen(imgElement, marca, colorFondo) {
            imgElement.onerror = null; // Prevenir bucles infinitos
            
            // Ocultar la imagen
            imgElement.style.display = 'none';
            
            // Crear placeholder si no existe
            let placeholder = imgElement.nextElementSibling;
            if (!placeholder || !placeholder.classList.contains('image-placeholder')) {
                placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.style.backgroundColor = colorFondo || '#f5f5f5';
                placeholder.textContent = marca;
                imgElement.parentNode.appendChild(placeholder);
            }
            
            placeholder.style.display = 'flex';
        }
        
        // Funci√≥n para obtener color seg√∫n categor√≠a
        function getColorPorCategoria(categoria) {
            const colores = {
                'S√©rums Faciales': '#e6f0f7',
                'Cremas Hidratantes': '#f7e6e6',
                'Cremas Faciales': '#f7f0e6',
                'Limpieza Facial': '#e6f7e9',
                'Esencias': '#f7e6f7',
                'Ampollas': '#e6e7f7',
                'Mascarillas': '#f0e6f7',
                'T√≥nicos': '#e6f4f7',
                'Protecci√≥n Solar': '#fff7e6',
                'Aceites': '#e6f7f7',
                'Exfoliantes': '#f7e6f0',
                'Contornos de Ojos': '#f0f7e6',
                'default': '#f5f5f5'
            };
            
            if (!categoria) return colores.default;
            
            for (const [key, color] of Object.entries(colores)) {
                if (categoria.includes(key)) return color;
            }
            return colores.default;
        }
        
        // Actualizar paginaci√≥n
        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(productosFiltrados.length / productosPorPagina);
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (totalPaginas <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            let html = '';
            
            // Bot√≥n anterior
            html += `
                <button class="page-btn ${paginaActual === 1 ? 'disabled' : ''}" 
                        onclick="${paginaActual > 1 ? `cambiarPagina(${paginaActual - 1})` : ''}">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // N√∫meros de p√°gina
            const paginasAMostrar = 5;
            let inicioPagina = Math.max(1, paginaActual - Math.floor(paginasAMostrar / 2));
            let finPagina = Math.min(totalPaginas, inicioPagina + paginasAMostrar - 1);
            
            if (finPagina - inicioPagina + 1 < paginasAMostrar) {
                inicioPagina = Math.max(1, finPagina - paginasAMostrar + 1);
            }
            
            for (let i = inicioPagina; i <= finPagina; i++) {
                html += `
                    <button class="page-btn ${i === paginaActual ? 'active' : ''}" 
                            onclick="cambiarPagina(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Bot√≥n siguiente
            html += `
                <button class="page-btn ${paginaActual === totalPaginas ? 'disabled' : ''}" 
                        onclick="${paginaActual < totalPaginas ? `cambiarPagina(${paginaActual + 1})` : ''}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationContainer.innerHTML = html;
        }
        
        // Cambiar p√°gina
        function cambiarPagina(nuevaPagina) {
            paginaActual = nuevaPagina;
            mostrarProductos();
            // Scroll suave hacia arriba
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Funci√≥n para actualizar el contador de productos
        function actualizarContadorProductos() {
            const element = document.getElementById('productCount');
            if (element) {
                const total = productosFiltrados.length;
                const mostrando = productosMostrados.length;
                const texto = total === mostrando ? 
                    `${total} productos` : 
                    `Mostrando ${mostrando} de ${total} productos`;
                element.textContent = texto;
            }
        }
        
        // Funci√≥n para mostrar error
        function mostrarError(mensaje) {
            const container = document.getElementById('productsContainer');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1/-1;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #d97777; margin-bottom: 20px;"></i>
                        <h3 style="color: #666; margin-bottom: 10px;">Error</h3>
                        <p>${mensaje}</p>
                        <button onclick="cargarProductos()" style="margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para buscar productos
        function buscarProductos() {
            const searchInput = document.getElementById('searchInput');
            const termino = searchInput.value.toLowerCase().trim();
            
            if (termino === '') {
                productosFiltrados = [...todosProductos];
            } else {
                productosFiltrados = todosProductos.filter(producto => {
                    return producto.nombre.toLowerCase().includes(termino) ||
                           producto.marca.toLowerCase().includes(termino) ||
                           (producto.categoria && producto.categoria.toLowerCase().includes(termino)) ||
                           (producto.descripcion && producto.descripcion.toLowerCase().includes(termino));
                });
            }
            
            paginaActual = 1;
            mostrarProductos();
            actualizarContadorProductos();
        }
        
        // Funci√≥n para abrir modal con producto CORREGIDA
        function abrirModalProducto(productId) {
            try {
                // Buscar el producto en TODOS los productos
                const producto = todosProductos.find(p => p.id === productId);
                
                if (!producto) {
                    console.error(`Producto con ID ${productId} no encontrado`);
                    alert('Producto no encontrado');
                    return;
                }
                
                // URL de la imagen (puede ser URL externa o null)
                const imagenUrl = producto.imagen || null;
                const colorFondo = getColorPorCategoria(producto.categoria);
                
                // Crear contenido del modal
                const modalHTML = `
                    <div class="product-modal">
                        <button class="modal-close" onclick="cerrarModalProducto()">√ó</button>
                        <div class="modal-content">
                            <div class="modal-product-info">
                                <div class="modal-product-image">
                                    <div class="image-container">
                                        ${imagenUrl ? 
                                            `<img src="${imagenUrl}" 
                                                  alt="${producto.nombre}"
                                                  onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">` 
                                            : 
                                            ''
                                        }
                                        <div class="image-placeholder" style="display: ${imagenUrl ? 'none' : 'flex'}; background-color: ${colorFondo}">
                                            ${producto.marca}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-product-details">
                                    <h2 class="modal-product-title">${producto.nombre}</h2>
                                    <div class="modal-product-price">US$ ${producto.precio.toFixed(2)}</div>
                                    <p><strong>Marca:</strong> ${producto.marca}</p>
                                    ${producto.categoria ? `<p><strong>Categor√≠a:</strong> ${producto.categoria}</p>` : ''}
                                    
                                    <div class="action-buttons" style="margin-top: 20px;">
                                        <button class="btn-add" onclick="agregarAlCarritoDesdeModal(${producto.id})">
                                            AGREGAR A LA CESTA
                                        </button>
                                    </div>
                                    
                                    <div class="modal-description">
                                        <h3>Descripci√≥n del Producto</h3>
                                        <p>${producto.descripcion || 'Sin descripci√≥n disponible.'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insertar modal en el contenedor
                const modalContainer = document.getElementById('productModal');
                if (modalContainer) {
                    modalContainer.innerHTML = modalHTML;
                    modalContainer.style.display = 'flex';
                    
                    // Prevenir scroll del body
                    document.body.style.overflow = 'hidden';
                    
                    // Cerrar modal al hacer clic fuera
                    modalContainer.addEventListener('click', function(e) {
                        if (e.target === this) {
                            cerrarModalProducto();
                        }
                    });
                    
                    // Cerrar con ESC
                    document.addEventListener('keydown', function escHandler(e) {
                        if (e.key === 'Escape') {
                            cerrarModalProducto();
                            document.removeEventListener('keydown', escHandler);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error al abrir modal:', error);
                alert('Error al cargar los detalles del producto');
            }
        }
        
        function cerrarModalProducto() {
            const modalContainer = document.getElementById('productModal');
            if (modalContainer) {
                modalContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        function agregarAlCarritoDesdeModal(productId) {
            agregarAlCarrito(productId);
            cerrarModalProducto();
        }
        
        // Funci√≥n para agregar al carrito MEJORADA
        function agregarAlCarrito(productId, buttonElement = null) {
            console.log(`üõí Agregando producto ${productId} al carrito`);
            
            // Verificar que el producto existe
            const producto = todosProductos.find(p => p.id === productId);
            if (!producto) {
                console.error(`Producto ID ${productId} no encontrado`);
                mostrarNotificacion('Error: Producto no encontrado', 'error');
                return;
            }
            
            // Cargar carrito existente
            const CARRITO_KEY = 'carrito_belleza_coreana';
            const carritoJSON = localStorage.getItem(CARRITO_KEY);
            let carrito = carritoJSON ? JSON.parse(carritoJSON) : [];
            
            // Validar que sea un array
            if (!Array.isArray(carrito)) {
                console.warn('Carrito no es array, inicializando nuevo');
                carrito = [];
            }
            
            // Buscar si el producto ya est√° en el carrito
            const index = carrito.findIndex(item => item && item.id === productId);
            
            if (index !== -1) {
                // Si ya existe, incrementar cantidad (m√°ximo 99)
                if (carrito[index].cantidad < 99) {
                    carrito[index].cantidad += 1;
                } else {
                    mostrarNotificacion('L√≠mite m√°ximo alcanzado (99 unidades)', 'warning');
                    return;
                }
            } else {
                // Si no existe, agregar nuevo
                carrito.push({
                    id: productId,
                    cantidad: 1
                });
            }
            
            // Guardar en localStorage
            localStorage.setItem(CARRITO_KEY, JSON.stringify(carrito));
            
            // Actualizar contador visual
            actualizarContadorCarrito();
            
            // Animaci√≥n del bot√≥n si se proporcion√≥
            if (buttonElement) {
                const originalText = buttonElement.textContent;
                const originalBg = buttonElement.style.backgroundColor;
                const originalColor = buttonElement.style.color;
                
                buttonElement.textContent = '¬°AGREGADO!';
                buttonElement.style.backgroundColor = '#4CAF50';
                buttonElement.style.color = 'white';
                buttonElement.disabled = true;
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.style.backgroundColor = originalBg || '#333';
                    buttonElement.style.color = originalColor || 'white';
                    buttonElement.disabled = false;
                }, 1500);
            }
            
            console.log(`üõí Carrito actualizado: ${carrito.length} tipos de productos`);
            
            // Mostrar notificaci√≥n
            mostrarNotificacion(`${producto.nombre.substring(0, 30)}... agregado al carrito`);
        }
        
        // Funci√≥n para mostrar notificaci√≥n mejorada
        function mostrarNotificacion(mensaje, tipo = 'success') {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = 'notification';
            
            const icon = tipo === 'error' ? 'fa-exclamation-circle' : 
                        tipo === 'warning' ? 'fa-exclamation-triangle' : 
                        'fa-check-circle';
            const bgColor = tipo === 'error' ? '#f44336' : 
                           tipo === 'warning' ? '#ff9800' : 
                           '#4CAF50';
            
            notificacion.innerHTML = `
                <i class="fas ${icon}" style="margin-right: 10px;"></i>
                ${mensaje}
            `;
            notificacion.style.backgroundColor = bgColor;
            
            document.body.appendChild(notificacion);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notificacion.style.opacity = '0';
                notificacion.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        document.body.removeChild(notificacion);
                    }
                }, 500);
            }, 3000);
        }
        
        // Funci√≥n para actualizar contador del carrito
        function actualizarContadorCarrito() {
            const CARRITO_KEY = 'carrito_belleza_coreana';
            const carritoJSON = localStorage.getItem(CARRITO_KEY);
            let totalItems = 0;
            
            if (carritoJSON) {
                try {
                    const carrito = JSON.parse(carritoJSON);
                    if (Array.isArray(carrito)) {
                        totalItems = carrito.reduce((total, item) => {
                            if (item && item.cantidad) {
                                return total + item.cantidad;
                            }
                            return total;
                        }, 0);
                    }
                } catch (error) {
                    console.error('Error al contar carrito:', error);
                }
            }
            
            // Actualizar badge
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
                badge.style.display = totalItems > 0 ? 'flex' : 'none';
            }
            
            return totalItems;
        }
        
        // Funci√≥n para buscar con Enter
        function setupBusqueda() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        buscarProductos();
                    }
                });
            }
        }
        
        // =================== INICIALIZACI√ìN ===================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando aplicaci√≥n...');
            cargarProductos();
            actualizarContadorCarrito();
            setupBusqueda();
            
            // Configurar tama√±o de productos por p√°gina seg√∫n el dispositivo
            if (window.innerWidth < 768) {
                productosPorPagina = 6;
            } else if (window.innerWidth < 1024) {
                productosPorPagina = 9;
            } else {
                productosPorPagina = 12;
            }
            
            console.log('‚úÖ Aplicaci√≥n inicializada');
        });
        
        // Hacer funciones disponibles globalmente
        window.abrirModalProducto = abrirModalProducto;
        window.cerrarModalProducto = cerrarModalProducto;
        window.agregarAlCarrito = agregarAlCarrito;
        window.agregarAlCarritoDesdeModal = agregarAlCarritoDesdeModal;
        window.buscarProductos = buscarProductos;
        window.manejarErrorImagen = manejarErrorImagen;
        window.aplicarFiltros = aplicarFiltros;
        window.cambiarPagina = cambiarPagina;
    </script>
</body>
</html> 